{% extends 'counseling/base.html' %}

{% block content %}
<div class="chat-container">
    <h2>ðŸ’¬ Live Chat Room: {{ room_name }}</h2>

    <div id="chat-log" class="chat-log styled-chat-log"></div>

    <input id="chat-message-input" type="text" size="100" placeholder="Type your message here..." autofocus>
    <button id="chat-message-submit" class="submit-btn">Send</button>
    <div id="typing-indicator" style="font-style: italic; color: #888; margin-top: 5px;"></div>
    
</div>

<script>
    const roomName = "{{ room_name }}";
    const userName = "{{ username }}";
    const userRole = "{{ user.student|yesno:'Student,Counselor' }}";

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onopen = function(e) {
        chatSocket.send(JSON.stringify({
            'message': userName + ' has joined the chat.',
            'system': true,
            'user': userName,
            'role': userRole
        }));
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const log = document.querySelector('#chat-log');

        // Typing indicator handler
        if (data.typing !== undefined) {
            const indicator = document.querySelector('#typing-indicator');
            if (data.typing) {
                indicator.textContent = `${data.user} (${data.role}) is typing...`;
            } else {
                indicator.textContent = '';
            }
            return;
        }

        // Message display
        const messageDiv = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (data.system) {
            messageDiv.className = 'chat-system';
            messageDiv.innerHTML = `${data.message} <div class="chat-meta">${timestamp}</div>`;
        } else {
            const cssClass = data.role === "Student" ? "chat-student" : "chat-counselor";
            messageDiv.className = `chat-message ${cssClass}`;
            messageDiv.innerHTML = `<strong>${data.user} (${data.role}):</strong> ${data.message}<div class="chat-meta">${timestamp}</div>`;
        }

        log.appendChild(messageDiv);
        log.scrollTop = log.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'user': userName,
            'role': userRole
        }));
        messageInputDom.value = '';
    };

    // Typing status logic
    let typingTimeout;
    document.querySelector('#chat-message-input').addEventListener('input', function () {
        clearTimeout(typingTimeout);
        chatSocket.send(JSON.stringify({
            'typing': true,
            'user': userName,
            'role': userRole
        }));

        typingTimeout = setTimeout(() => {
            chatSocket.send(JSON.stringify({
                'typing': false,
                'user': userName,
                'role': userRole
            }));
        }, 2000); // Stop typing after 2 seconds of no input
    });
</script>

<style>
.chat-log {
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 6px;
    background: #f4f4f4;
}

.chat-message {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    max-width: 75%;
    word-wrap: break-word;
    position: relative;
}

.chat-student {
    background-color: #d1ecf1;
    color: #0c5460;
    margin-left: auto;
    text-align: right;
}

.chat-counselor {
    background-color: #f8d7da;
    color: #721c24;
    margin-right: auto;
    text-align: left;
}

.chat-system {
    background-color: #e2e3e5;
    color: #383d41;
    text-align: center;
    font-style: italic;
    border-left: 5px solid #6c757d;
    padding-left: 10px;
}

.chat-meta {
    font-size: 0.75rem;
    color: #666;
    margin-top: 4px;
    text-align: right;
}
</style>

{% endblock %}
